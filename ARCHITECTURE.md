# Архитектура приложения МедКарта

## Обзор

Приложение МедКарта разработано с использованием современной архитектуры MVVM (Model-View-ViewModel) и следует принципам Clean Architecture.

## Архитектурные слои

### 1. Presentation Layer (UI)

**Компоненты:**
- `LoginActivity` - экран аутентификации
- `MainActivity` - главный экран со списком пациентов
- `PatientDetailActivity` - детальная информация о пациенте
- `PatientAdapter` - адаптер для RecyclerView

**Ответственность:**
- Отображение данных пользователю
- Обработка пользовательского ввода
- Навигация между экранами

### 2. ViewModel Layer

**Компоненты:**
- `AuthViewModel` - управление состоянием аутентификации
- `PatientViewModel` - управление списком и детальной информацией о пациентах

**Ответственность:**
- Бизнес-логика приложения
- Подготовка данных для отображения
- Управление состоянием UI
- Взаимодействие с Repository

**Преимущества:**
- Отделение бизнес-логики от UI
- Сохранение состояния при изменении конфигурации
- Упрощенное тестирование

### 3. Repository Layer

**Компоненты:**
- `PatientRepository` - работа с медицинскими картами
- `AuthRepository` - управление аутентификацией

**Ответственность:**
- Единая точка доступа к данным
- Абстракция источников данных (Firebase, локальная БД)
- Кэширование данных
- Логирование аудита

### 4. Model Layer

**Компоненты:**
- `Patient` - модель пациента
- `User` - модель пользователя системы
- `MedicalRecord` - медицинская запись
- `AuditLog` - запись журнала аудита

**Ответственность:**
- Определение структуры данных
- Бизнес-правила валидации

### 5. Security Layer

**Компоненты:**
- `EncryptionManager` - шифрование данных
- `BiometricAuthManager` - биометрическая аутентификация

**Ответственность:**
- Шифрование/расшифровка персональных данных
- Управление ключами шифрования
- Биометрическая аутентификация

## Поток данных

```
User Input
    ↓
Activity/Fragment
    ↓
ViewModel
    ↓
Repository
    ↓
Firebase/Local DB
    ↓
Security Layer (encryption)
    ↓
Cloud Storage
```

## Безопасность

### Шифрование данных

1. **Генерация ключа:**
   - Ключ генерируется в Android Keystore
   - Используется AES-256-GCM
   - Ключ не может быть экспортирован с устройства

2. **Процесс шифрования:**
   ```
   Данные → Encryption → IV + Encrypted Data → Base64 → Firebase
   ```

3. **Процесс расшифровки:**
   ```
   Firebase → Base64 Decode → IV + Encrypted Data → Decryption → Данные
   ```

### Аутентификация

1. **Двухфакторная:**
   - Пароль (знание)
   - Биометрия (владение)

2. **Процесс входа:**
   ```
   Email + Password → Firebase Auth → Success
                                         ↓
                                    Biometric Auth → Access Granted
   ```

### Журнал аудита

Каждое действие логируется:
- Кто (userId)
- Что (action)
- Когда (timestamp)
- Где (resource)
- Результат (success/failure)

## Работа с Firebase

### Firestore Collections

```
firestore/
├── patients/
│   └── {patientId}/
│       ├── personalData (encrypted)
│       ├── medicalHistory[]
│       └── metadata
├── users/
│   └── {userId}/
│       ├── profile
│       ├── role
│       └── permissions[]
└── audit_logs/
    └── {logId}/
        ├── action
        ├── timestamp
        └── details
```

### Security Rules

```javascript
// Только авторизованные пользователи
allow read, write: if request.auth != null;

// Пользователь может изменять только свои данные
allow write: if request.auth.uid == userId;

// Проверка роли
allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "ADMIN";
```

## Обработка ошибок

### Стратегия обработки:

1. **Network Errors:**
   - Повторная попытка с exponential backoff
   - Показ понятного сообщения пользователю

2. **Authentication Errors:**
   - Автоматический logout при истечении токена
   - Перенаправление на экран входа

3. **Data Errors:**
   - Валидация на клиенте перед отправкой
   - Fallback к локальным данным при недоступности сервера

## Тестирование

### Unit Tests
- ViewModel логика
- Repository операции
- Шифрование/расшифровка

### Integration Tests
- Firebase операции
- Взаимодействие компонентов

### UI Tests
- Сценарии пользователя
- Навигация

## Производительность

### Оптимизации:

1. **Пагинация:**
   - Загрузка данных порциями
   - Виртуальная прокрутка RecyclerView

2. **Кэширование:**
   - In-memory кэш для часто запрашиваемых данных
   - Offline-first подход

3. **Фоновая работа:**
   - Использование Kotlin Coroutines
   - Отмена операций при необходимости

## Масштабируемость

### Горизонтальное масштабирование:

1. **Модульность:**
   - Каждый компонент независим
   - Легко добавить новые функции

2. **Firebase Auto-scaling:**
   - Автоматическое масштабирование базы данных
   - Нет ограничений на количество пользователей

3. **Расширяемость:**
   - Новые типы документов
   - Дополнительные источники данных
   - Интеграция с внешними системами

## Соответствие требованиям

### 152-ФЗ:
✓ Шифрование персональных данных
✓ Контроль доступа
✓ Журналирование
✓ Согласие на обработку

### HIPAA:
✓ Защита PHI (Protected Health Information)
✓ Аудит доступа
✓ Шифрование при передаче и хранении
✓ Управление правами доступа

## Будущие улучшения

1. **Offline Mode:**
   - Полная работа без интернета
   - Синхронизация при подключении

2. **Analytics:**
   - Мониторинг использования
   - Отслеживание ошибок

3. **Push Notifications:**
   - Напоминания о приемах
   - Уведомления о новых результатах анализов

4. **Multi-language:**
   - Поддержка нескольких языков
   - Локализация контента

5. **Телемедицина:**
   - Видеоконсультации
   - Онлайн-чат с врачом
